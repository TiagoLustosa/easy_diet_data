# firstMealFoodList = [{
#     "baseQuantity": 100,
#     "base_unit": "g",
#     "carbohydrate": 0.614916666666674,
#     "category_id": 1,
#     "description": "Ovo inteiro, cozido",
#     "energyInKcal": 145.70017,
#     "fiber": 0,
#     "highProtein": True,
#     "isInMainMeal": False,
#     "id": 488,
#     "image": "https://firebasestorage.googleapis.com/v0/b/easydiet-48b9e.appspot.com/o/ovoCozido.jpg?alt=media&token=8df4d59e-0b3f-450e-a9ea-cf20ee211ce1",
#     "lipid": 9.47633333333333,
#     "protein": 13.29375
# },
#     {
#     "baseQuantity": 100,
#     "base_unit": "g",
#     "carbohydrate": 58.6464347826087,
#     "category_id": 1,
#     "description": "Pão francês",
#     "energyInKcal": 299.810150434783,
#     "fiber": 2.30666666666667,
#     "highCarb": True,
#     "isInMainMeal": False,
#     "id": 53,
#     "image": "https://firebasestorage.googleapis.com/v0/b/easydiet-48b9e.appspot.com/o/PaoFrances.jpg?alt=media&token=a866137b-68bf-42b3-9edf-1062107daf6a",
#     "lipid": 3.10333333333333,
#     "protein": 7.9535652173913
# },
#     {
#     "baseQuantity": 100,
#     "base_unit": "g",
#     "carbohydrate": 3.04933292706807,
#     "category_id": 1,
#     "description": "Queijo mussarela",
#     "energyInKcal": 329.870718420887,
#     "fiber": "NA",
#     "highLipid": True,
#     "isInMainMeal": False,
#     "id": 463,
#     "image": "https://firebasestorage.googleapis.com/v0/b/easydiet-48b9e.appspot.com/o/Mussarela.jpg?alt=media&token=16132a43-caca-4ee1-9704-b50d85467319",
#     "lipid": 25.183,
#     "protein": 22.6490004062653
# },
# ]
# secondMealFoodList = [
#     {
#         "baseQuantity": 100,
#         "base_unit": "g",
#         "carbohydrate": 0,
#         "category_id": 1,
#         "description": "Salmão, sem pele, fresco, cru",
#         "energyInKcal": 169.781579910556,
#         "fiber": 0,
#         "highProtein": True,
#         "isInMainMeal": True,
#         "id": 316,
#         "image": "https://firebasestorage.googleapis.com/v0/b/easydiet-48b9e.appspot.com/o/salmao.png?alt=media&token=3523f024-a202-4853-bfa7-07e544e7bc9a",
#         "lipid": 9.709,
#         "protein": 19.2520833333333
#     },
#     {
#         "baseQuantity": 100,
#         "base_unit": "g",
#         "carbohydrate": 28.05985,
#         "category_id": 1,
#         "description": "Arroz, tipo 1, cozido",
#         "energyInKcal": 128.258485666667,
#         "fiber": 1.561,
#         "highCarb": True,
#         "isInMainMeal": True,
#         "id": 3,
#         "image": "https://firebasestorage.googleapis.com/v0/b/easydiet-48b9e.appspot.com/o/arroz-branco.jpg?alt=media&token=ab13cc9b-9497-43e5-a79f-647015cb8e9d",
#         "lipid": 0.227,
#         "protein": 2.52081666666667
#     },
#     {
#         "baseQuantity": 100,
#         "base_unit": "g",
#         "carbohydrate": 0,
#         "category_id": 4,
#         "description": "Azeite oliva, extra virgem",
#         "energyInKcal": 884,
#         "fiber": 0,
#         "highLipid": True,
#         "isInMainMeal": True,
#         "id": 260,
#         "image": "https://firebasestorage.googleapis.com/v0/b/easydiet-48b9e.appspot.com/o/azeite-oliva.jpg?alt=media&token=4a7b3407-9257-4717-836f-c4f81740729e",
#         "lipid": 100,
#         "protein": 0
#     },
# ]
# thirdMealFoodList = [
#     {
#         "baseQuantity": 100,
#         "base_unit": "g",
#         "carbohydrate": 66.6356405797102,
#         "category_id": 1,
#         "description": "Aveia flocos",
#         "energyInKcal": 393.822689449275,
#         "fiber": 9.13,
#         "highCarb": True,
#         "isInMainMeal": False,
#         "id": 7,
#         "image": "https://firebasestorage.googleapis.com/v0/b/easydiet-48b9e.appspot.com/o/aveiaFlocos.jpg?alt=media&token=0840ca8a-297e-43fc-955e-6d465f6a0b1d",
#         "lipid": 8.49666666666667,
#         "protein": 13.9210260869565
#     },
#     {
#         "baseQuantity": 100,
#         "base_unit": "g",
#         "carbohydrate": 4,
#         "description": "Whey Protein(Concentrado) 80%",
#         "energyInKcal": 122,
#         "fiber": 0,
#         "highProtein": True,
#         "isInMainMeal": False,
#         "id": 777,
#         "image": "",
#         "lipid": 1.6,
#         "protein": 23
#     },
#     {
#         "baseQuantity": 100,
#         "base_unit": "g",
#         "carbohydrate": 1.91666666666666,
#         "category_id": 1,
#         "description": "Iogurte natural integral",
#         "energyInKcal": 51.4895333333333,
#         "fiber": 0,
#         "highLipid": True,
#         "isInMainMeal": False,
#         "id": 448,
#         "image": "https://firebasestorage.googleapis.com/v0/b/easydiet-48b9e.appspot.com/o/IogurteIntegral.jpg?alt=media&token=e5eba4f6-b1fa-4248-93f4-71f4c4f5e8dc",
#         "lipid": 3.04,
#         "protein": 4.06333333333333
#     },
# ]

# fourthMealFoodList = [
#     {
#         "baseQuantity": 100,
#         "base_unit": "g",
#         "carbohydrate": 0,
#         "category_id": 6,
#         "description": "Frango, sobrecoxa, sem pele, assada",
#         "energyInKcal": 232.883396666667,
#         "fiber": 0,
#         "highProtein": True,
#         "id": 413,
#         "lipid": 12.0073333333333,
#         "protein": 29.175
#     },
#     {
#         "baseQuantity": 100,
#         "base_unit": "g",
#         "carbohydrate": 25.80975,
#         "category_id": 1,
#         "description": "Arroz, integral, cozido",
#         "energyInKcal": 123.5348925,
#         "fiber": 2.74933333333333,
#         "highCarb": True,
#         "id": 1,
#         "lipid": 1.00033333333333,
#         "protein": 2.58825
#     },
#     {
#         "baseQuantity": 100,
#         "base_unit": "g",
#         "carbohydrate": 0,
#         "category_id": 4,
#         "description": "Azeite, de oliva, extra virgem",
#         "energyInKcal": 884,
#         "fiber": 0,
#         "highLipid": True,
#         "id": 260,
#         "lipid": 100,
#         "protein": 0
#     }
# ]
import json


def calculateTotalMacros(userData):
    totalProtein = userData['weight'] * \
        userData['proteinPerKilogramOfBodyWeight']
    totalLipid = userData['weight'] * 1
    macros = {
        'totalProtein': totalProtein,
        'totalLipid': totalLipid
    }
    return macros


def calculateBasalMetabolicRate(userData):
    activityLevelFactor = 1.2
    dietObjective = 0
    if userData['dietObjective'] == 'maintainWeight':
        dietObjective = 0
    if userData['dietObjective'] == 'loseWeight':
        dietObjective = -500
    if userData['dietObjective'] == 'gainWeight':
        dietObjective = 500
    if userData['activityLevel'] == 'sedentary':
        activityLevelFactor = 1.2
    if userData['activityLevel'] == 'lightlyActive':
        activityLevelFactor = 1.375
    if userData['activityLevel'] == 'moderatelyActive':
        activityLevelFactor = 1.55
    if userData['activityLevel'] == 'veryActive':
        activityLevelFactor = 1.725
    if userData['activityLevel'] == 'superActive':
        activityLevelFactor = 1.9
    if userData['gender'] == 'male':
        return (66.47 + (13.75 * userData['weight'])
                + (5.003 * userData['height'])
                - (6.755 * userData['age'])) * activityLevelFactor + dietObjective
    else:
        return (655.1 + (9.563 * userData['weight'])
                + (1.85 * userData['height'])
                - (4.676 * userData['age'])) * activityLevelFactor + dietObjective


totalProteinInMeal = 160
totalLipidInMeal = 80
totalCaloriesInMeal = 2500

totalProteinFirstMeal = totalProteinInMeal * 0.2
totalLipidFirstMeal = totalLipidInMeal * 0.2
totalCaloriesFirstMeal = totalCaloriesInMeal * 0.2

totalProteinSecondMeal = totalProteinInMeal * 0.3
totalLipidSecondMeal = totalLipidInMeal * 0.3
totalCaloriesInSecondMeal = totalCaloriesInMeal * 0.3

totalProteinThirdMeal = totalProteinInMeal * 0.2
totalLipidThirdMeal = totalLipidInMeal * 0.2
totalCaloriesInThirdMeal = totalCaloriesInMeal * 0.2

totalProteinInFourthMeal = 0
totalLipidInFourthMeal = 0
totalCaloriesInFourthMeal = 0

meal_number = 1


def calculateMeal(foodList, totalProtein, totalLipid, totalCaloriesInMeal):
    totalProteinGrams = 0
    proteinResult = 0
    totalLipidGrams = 0
    lipidResult = 0
    totalCarboGrams = 0
    carboResult = 0
    totalKcal = 0.0

    protein = next(
        (e for e in foodList if 'highProtein' in e and e['highProtein']), None)
    lipid = next(
        (e for e in foodList if 'highLipid' in e and e['highLipid']), None)
    carbo = next(
        (e for e in foodList if 'highCarb' in e and e['highCarb']), None)

    proteinPerGram = protein['protein'] / 100
    proteinKcalPerGram = protein['energyInKcal'] / 100
    proteinLipidPerGram = protein['lipid'] / 100
    proteinCarboPerGram = protein['carbohydrate'] / 100

    lipidPerGram = lipid['lipid'] / 100
    lipidKcalPerGram = lipid['energyInKcal'] / 100
    lipidProteinPerGram = lipid['protein'] / 100
    lipidCarboPerGram = lipid['carbohydrate'] / 100

    carboPerGram = carbo['carbohydrate'] / 100
    carboKcalPerGram = carbo['energyInKcal'] / 100
    carboLipidPerGram = carbo['lipid'] / 100
    carboProteinPerGram = carbo['protein'] / 100

    mealNumber = 1
    while totalKcal < totalCaloriesInMeal:
        if mealNumber == 1 and (protein['protein'] / protein['lipid'] < 2.4 or lipid['protein'] / lipid['lipid'] < 2.4):
            highFatMeal = totalCaloriesFirstMeal * 0.17
            totalGramsFromLipidSource = highFatMeal / lipidKcalPerGram
            while totalLipidGrams < totalGramsFromLipidSource:
                proteinResult += lipidProteinPerGram
                totalKcal += lipidKcalPerGram
                carboResult += lipidCarboPerGram
                lipidResult += lipidPerGram
                totalLipidGrams += 1
        while proteinResult < totalProtein:
            proteinResult += proteinPerGram
            totalKcal += proteinKcalPerGram
            carboResult += proteinCarboPerGram
            lipidResult += proteinLipidPerGram
            totalProteinGrams += 1
        if lipidResult < totalLipid:
            proteinResult += lipidProteinPerGram
            totalKcal += lipidKcalPerGram
            carboResult += lipidCarboPerGram
            lipidResult += lipidPerGram
            totalLipidGrams += 1
        if totalKcal >= totalCaloriesInMeal:
            while proteinResult < totalProtein or lipidResult > totalLipid:
                proteinResult -= lipidProteinPerGram
                totalKcal -= lipidKcalPerGram
                carboResult -= lipidCarboPerGram
                lipidResult -= lipidPerGram
                totalLipidGrams -= 1

                proteinResult += proteinPerGram
                totalKcal += proteinKcalPerGram
                carboResult += proteinCarboPerGram
                lipidResult += proteinLipidPerGram
                totalProteinGrams += 1

        if proteinResult > (totalProtein + (totalProtein * 0.03)):
            while proteinResult > (totalProtein + (totalProtein * 0.03)):
                proteinResult -= proteinPerGram
                totalKcal -= proteinKcalPerGram
                carboResult -= proteinCarboPerGram
                lipidResult -= proteinLipidPerGram
                totalProteinGrams -= 1

        proteinResult += carboProteinPerGram
        totalKcal += carboKcalPerGram
        carboResult += carboPerGram
        lipidResult += carboLipidPerGram
        totalCarboGrams += 1

    mealResult = {
        'totalKcal': totalKcal,
        'proteinSource': totalProteinGrams,
        'lipidSource': totalLipidGrams,
        'carboSource': totalCarboGrams,
        'foods': foodList,
        'totalProteinInMeal': proteinResult,
        'totalLipidInMeal': lipidResult,
        'totalCarboInMeal': carboResult
    }
    mealNumber += 1
    return mealResult


def calculateDietFourMeals(userData):

    firstMealResult = calculateMeal(
        userData['firstMealFoodList'], totalProteinFirstMeal, totalLipidFirstMeal, totalCaloriesFirstMeal)
    secondMealResult = calculateMeal(
        userData['secondMealFoodList'], totalProteinSecondMeal, totalLipidSecondMeal, totalCaloriesInSecondMeal)
    thirdMealResult = calculateMeal(
        userData['thirdMealFoodList'], totalProteinThirdMeal, totalLipidThirdMeal, totalCaloriesInThirdMeal)
    totalProteinInFourthMeal = totalProteinInMeal - \
        (firstMealResult["totalProteinInMeal"] +
         secondMealResult["totalProteinInMeal"] + thirdMealResult["totalProteinInMeal"])
    totalLipidInFourthMeal = totalLipidInMeal - \
        (firstMealResult["totalLipidInMeal"] +
         secondMealResult["totalLipidInMeal"] + thirdMealResult["totalLipidInMeal"])
    totalCaloriesInFourthMeal = totalCaloriesInMeal - \
        (firstMealResult["totalKcal"] +
         secondMealResult["totalKcal"] + thirdMealResult["totalKcal"])
    fourthMealResult = calculateMeal(
        userData['fourthMealFoodList'], totalProteinInFourthMeal, totalLipidInFourthMeal, totalCaloriesInFourthMeal)
    totalMacrosInDiet = {
        "totalCaloriesInDiet": (firstMealResult["totalKcal"] + secondMealResult["totalKcal"] + thirdMealResult["totalKcal"] + fourthMealResult["totalKcal"]),
        "totalProteinInDiet": (firstMealResult["totalProteinInMeal"] + secondMealResult["totalProteinInMeal"] + thirdMealResult["totalProteinInMeal"] + fourthMealResult["totalProteinInMeal"]),
        "totalLipidInDiet": (firstMealResult["totalLipidInMeal"] + secondMealResult["totalLipidInMeal"] + thirdMealResult["totalLipidInMeal"] + fourthMealResult["totalLipidInMeal"]),
        "totalCarboInDiet": (firstMealResult["totalCarboInMeal"] + secondMealResult["totalCarboInMeal"] + thirdMealResult["totalCarboInMeal"] + fourthMealResult["totalCarboInMeal"])
    }
    fullDiet = {
        "firstMealResult": firstMealResult,
        "secondMealResult": secondMealResult,
        "thirdMealResult": thirdMealResult,
        "fourthMealResult": fourthMealResult,
        "totalMacrosInDiet": totalMacrosInDiet
    }
    return fullDiet


with open('C:\projects\easy_diet_cloud_functions\user_data.json', 'r', encoding="utf8") as input_file:
    userDataJson = json.load(input_file)

for i in userDataJson:

    bmr = calculateBasalMetabolicRate(i)
    macros = calculateTotalMacros(i)
    totalProteinInMeal = macros['totalProtein']
    totalLipidInMeal = macros['totalLipid']
    totalCaloriesInMeal = bmr
    calculateDietFourMeals(i)
